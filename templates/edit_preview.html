{% extends "base.html" %}

{% block title %}Edit & Preview - Chemical Document Pro{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Compact Progress Pipeline -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="pipeline-progress">
                        <div class="progress-step completed">
                            <div class="step-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <div class="step-label">Upload</div>
                        </div>
                        <div class="progress-step completed">
                            <div class="step-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="step-label">Extract</div>
                        </div>
                        <div class="progress-step active">
                            <div class="step-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="step-label">Edit</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="step-label">Approve</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="step-label">Export</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <!-- Compact Edit Panel -->
        <div class="col-lg-5">
            <div class="card sticky-top">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-edit me-2"></i>
                            Edit Document Data
                        </h6>
                        <span class="document-type-indicator" id="currentDocumentType">COA Fields</span>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="edit-panel">
                        <form id="editForm" onsubmit="return false;">
                            <!-- Common Fields -->
                            <div id="commonFields" class="mb-3">
                                <h6 class="text-muted mb-2 text-xs">Product Information</h6>
                                
                                <div class="mb-2">
                                    <label class="form-label text-sm">Company Product Name</label>
                                    <input type="text" class="form-control form-control-sm editable-field" 
                                           data-field="company_product_name" 
                                           value="{{ doc_set.company_product_name }}"
                                           placeholder="Enter product name">
                                </div>

                                <div class="mb-2">
                                    <label class="form-label text-sm">Supplier Name</label>
                                    <input type="text" class="form-control form-control-sm editable-field" 
                                           data-field="supplier_name" 
                                           value="{{ doc_set.supplier_name or '' }}"
                                           placeholder="Enter supplier name">
                                </div>
                            </div>

                            <!-- COA Specific Fields -->
                            <div id="coaFields" class="document-fields">
                                <div class="mb-3">
                                    <h6 class="text-muted mb-2 text-xs">Certificate Details</h6>
                                    
                                    <div class="mb-2">
                                        <label class="form-label text-sm">INCI Name</label>
                                        <input type="text" class="form-control form-control-sm editable-field" 
                                               data-field="inci_name" 
                                               value="{{ doc_set.inci_name or '' }}"
                                               placeholder="Enter INCI name">
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label text-sm">Batch Number</label>
                                        <input type="text" class="form-control form-control-sm editable-field" 
                                               data-field="batch_number" 
                                               value="{{ doc_set.batch_number or '' }}"
                                               placeholder="Enter batch number">
                                    </div>

                                    <div class="row g-2 mb-2">
                                        <div class="col-6">
                                            <label class="form-label text-sm">Mfg. Date</label>
                                            <input type="date" class="form-control form-control-sm editable-field" 
                                                   data-field="manufacturing_date" 
                                                   value="{% if doc_set.manufacturing_date %}{{ doc_set.manufacturing_date.strftime('%Y-%m-%d') }}{% endif %}">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label text-sm">Exp. Date</label>
                                            <input type="date" class="form-control form-control-sm editable-field" 
                                                   data-field="expiry_date" 
                                                   value="{% if doc_set.expiry_date %}{{ doc_set.expiry_date.strftime('%Y-%m-%d') }}{% endif %}">
                                        </div>
                                    </div>
                                </div>

                                <!-- Test Results Table -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="text-muted mb-0 text-xs">Test Results</h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary btn-xs" onclick="addTestResult()">
                                            <i class="fas fa-plus me-1"></i>Add
                                        </button>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-sm editable-table" id="testResultsTable">
                                            <thead>
                                                <tr>
                                                    <th class="text-xs">Parameter</th>
                                                    <th class="text-xs">Result</th>
                                                    <th class="text-xs w-auto">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for test in doc_set.test_results %}
                                                <tr data-test-id="{{ test.id }}">
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm editable-cell test-parameter border-0" 
                                                               value="{{ test.parameter_name }}" 
                                                               data-test-id="{{ test.id }}">
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm editable-cell test-result border-0" 
                                                               value="{{ test.result }}"
                                                               data-test-id="{{ test.id }}">
                                                    </td>
                                                    <td class="table-actions">
                                                        <button type="button" class="btn btn-outline-danger btn-sm remove-test-btn"
                                                                data-test-id="{{ test.id }}">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- MSDS Specific Fields -->
                            <div id="msdsFields" class="document-fields" style="display: none;">
                                <div class="mb-3">
                                    <h6 class="text-muted mb-2 text-xs">Chemical Information</h6>
                                    
                                    <div class="mb-2">
                                        <label class="form-label text-sm">CAS Number</label>
                                        <input type="text" class="form-control form-control-sm editable-field" 
                                               data-field="cas_number" 
                                               value="{{ doc_set.cas_number or '' }}"
                                               placeholder="Enter CAS number">
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label text-sm">Molecular Formula</label>
                                        <input type="text" class="form-control form-control-sm editable-field" 
                                               data-field="molecular_formula" 
                                               value="{{ doc_set.molecular_formula or '' }}"
                                               placeholder="Enter molecular formula">
                                    </div>
                                </div>

                                <!-- Physical Properties Table -->
                                <div class="mb-3">
                                    <h6 class="text-muted mb-2 text-xs">Physical Properties</h6>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-sm editable-table">
                                            <thead>
                                                <tr>
                                                    <th class="text-xs">Property</th>
                                                    <th class="text-xs">Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% set physical_props = extracted_data.get('physical_properties', {}) %}
                                                <tr>
                                                    <td class="text-sm fw-medium">Appearance</td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm editable-cell border-0" 
                                                               data-field="physical_properties.appearance" 
                                                               value="{{ physical_props.get('appearance', '') }}"
                                                               placeholder="Enter appearance">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="text-sm fw-medium">Solubility</td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm editable-cell border-0" 
                                                               data-field="physical_properties.solubility" 
                                                               value="{{ physical_props.get('solubility', '') }}"
                                                               placeholder="Enter solubility">
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- TDS Specific Fields -->
                            <div id="tdsFields" class="document-fields" style="display: none;">
                                <div class="mb-3">
                                    <h6 class="text-muted mb-2 text-xs">Technical Information</h6>
                                    
                                    <div class="mb-2">
                                        <label class="form-label text-sm">Use Level</label>
                                        <input type="text" class="form-control form-control-sm editable-field" 
                                               data-field="recommended_use_level" 
                                               value="{{ extracted_data.get('recommended_use_level', '') }}"
                                               placeholder="Enter use level">
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label text-sm">Storage Conditions</label>
                                        <textarea class="form-control form-control-sm editable-field" 
                                                  data-field="storage_conditions" 
                                                  rows="2"
                                                  placeholder="Enter storage conditions">{{ extracted_data.get('storage_conditions', '') }}</textarea>
                                    </div>

                                    <div class="mb-2">
                                        <label class="form-label text-sm">Shelf Life</label>
                                        <input type="text" class="form-control form-control-sm editable-field" 
                                               data-field="shelf_life" 
                                               value="{{ extracted_data.get('shelf_life', '') }}"
                                               placeholder="Enter shelf life">
                                    </div>
                                </div>

                                <!-- Specifications Table -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="text-muted mb-0 text-xs">Specifications</h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary btn-xs" onclick="addSpecification()">
                                            <i class="fas fa-plus me-1"></i>Add
                                        </button>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-sm editable-table" id="specificationsTable">
                                            <thead>
                                                <tr>
                                                    <th class="text-xs">Specification</th>
                                                    <th class="text-xs">Value</th>
                                                    <th class="text-xs w-auto">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% set specs = extracted_data.get('specifications', {}) %}
                                                {% for spec_name, spec_value in specs.items() %}
                                                <tr>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm editable-cell spec-name border-0" 
                                                               value="{{ spec_name }}" 
                                                               data-original-name="{{ spec_name }}">
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm editable-cell spec-value border-0" 
                                                               value="{{ spec_value }}"
                                                               data-spec-name="{{ spec_name }}">
                                                    </td>
                                                    <td class="table-actions">
                                                        <button type="button" class="btn btn-outline-danger btn-sm remove-spec-btn">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Compact Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-sm" onclick="approveDocuments()">
                            <i class="fas fa-check me-2"></i>
                            Approve Documents
                        </button>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('upload') }}" class="btn btn-secondary btn-sm flex-fill">
                                <i class="fas fa-arrow-left me-1"></i>
                                Back
                            </a>
                            <button type="button" class="btn btn-outline-primary btn-sm flex-fill" onclick="downloadAllAsZip({{ doc_set.id }})">
                                <i class="fas fa-download me-1"></i>
                                Download ZIP
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compact Preview Panel -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Document Preview
                        </h6>
                        <!-- Document Type Switcher -->
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" 
                                    id="previewBtnCoa" onclick="switchPreview('coa')">
                                <i class="fas fa-certificate me-1"></i>COA
                            </button>
                            <button type="button" class="btn btn-outline-primary" 
                                    id="previewBtnMsds" onclick="switchPreview('msds')">
                                <i class="fas fa-shield-alt me-1"></i>MSDS
                            </button>
                            <button type="button" class="btn btn-outline-primary" 
                                    id="previewBtnTds" onclick="switchPreview('tds')">
                                <i class="fas fa-clipboard-list me-1"></i>TDS
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="preview-container">
                        <!-- Loading State -->
                        <div class="preview-loading d-none" id="previewLoading">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2 text-muted text-sm">Updating preview...</div>
                            </div>
                        </div>
                        
                        <!-- Preview Frame -->
                        <iframe id="previewFrame" 
                                src="/api/preview/{{ doc_set.id }}/coa" 
                                width="100%" 
                                height="600"
                                style="border: none;">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title">
                    <i class="fas fa-check-circle me-2 text-success"></i>
                    Approve Documents
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-sm">Confirm that you have reviewed all documents and are ready to approve them.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>Once approved, documents will be finalized and ready for download.</small>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success btn-sm" onclick="confirmApproval()">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const docSetId = {{ doc_set.id }};
    let currentPreview = 'coa';
    let updateTimeout = null;

    // Initialize edit handlers
    document.querySelectorAll('.editable-field, .editable-cell').forEach(field => {
        field.addEventListener('input', function() {
            const fieldName = this.dataset.field;
            const fieldValue = this.value;
            
            if (fieldName && updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            if (fieldName) {
                updateTimeout = setTimeout(() => {
                    updateField(fieldName, fieldValue);
                }, 500);
            }
        });
    });

    // Initialize handlers
    initializeTableHandlers();
    switchPreview('coa'); // Show COA fields by default

    function initializeTableHandlers() {
        // Test result handlers
        document.querySelectorAll('.test-parameter, .test-result').forEach(field => {
            field.addEventListener('input', function() {
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }
                updateTimeout = setTimeout(() => {
                    updatePreview();
                }, 500);
            });
        });

        // Specification handlers
        document.querySelectorAll('.spec-value').forEach(field => {
            field.addEventListener('input', function() {
                const specName = this.dataset.specName;
                const specValue = this.value;
                
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }
                
                updateTimeout = setTimeout(() => {
                    updateSpecification(specName, specValue);
                }, 500);
            });
        });

        // Remove button handlers
        document.querySelectorAll('.remove-test-btn, .remove-spec-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('tr').remove();
                updatePreview();
            });
        });
    }

    async function updateField(fieldName, fieldValue) {
        try {
            const response = await fetch(`/api/update-field/${docSetId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ field_name: fieldName, field_value: fieldValue })
            });
            
            if (response.ok) {
                updatePreview();
            }
        } catch (error) {
            console.error('Error updating field:', error);
        }
    }

    async function updateSpecification(specName, specValue) {
        try {
            const response = await fetch(`/api/update-specification/${docSetId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spec_name: specName, spec_value: specValue })
            });
            
            if (response.ok) {
                updatePreview();
            }
        } catch (error) {
            console.error('Error updating specification:', error);
        }
    }

    function updatePreview() {
        const previewFrame = document.getElementById('previewFrame');
        const loadingDiv = document.getElementById('previewLoading');
        
        loadingDiv.classList.remove('d-none');
        previewFrame.style.opacity = '0.5';
        
        const timestamp = new Date().getTime();
        previewFrame.src = `/api/preview/${docSetId}/${currentPreview}?t=${timestamp}`;
        
        previewFrame.onload = function() {
            loadingDiv.classList.add('d-none');
            previewFrame.style.opacity = '1';
        };
    }

    function switchPreview(docType) {
        currentPreview = docType;
        
        // Update button states
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`previewBtn${docType.charAt(0).toUpperCase() + docType.slice(1)}`).classList.add('active');
        
        // Update type indicator
        const indicator = document.getElementById('currentDocumentType');
        const documentNames = { 'coa': 'COA Fields', 'msds': 'MSDS Fields', 'tds': 'TDS Fields' };
        indicator.textContent = documentNames[docType] || 'Document Fields';
        
        // Show/hide field sections
        document.querySelectorAll('.document-fields').forEach(section => section.style.display = 'none');
        const targetSection = document.getElementById(`${docType}Fields`);
        if (targetSection) targetSection.style.display = 'block';
        
        updatePreview();
    }

    function addTestResult() {
        const tbody = document.querySelector('#testResultsTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>
                <input type="text" class="form-control form-control-sm editable-cell test-parameter border-0" 
                       placeholder="Parameter name">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm editable-cell test-result border-0" 
                       placeholder="Result">
            </td>
            <td class="table-actions">
                <button type="button" class="btn btn-outline-danger btn-sm remove-test-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
        
        // Initialize handlers for new row
        newRow.querySelectorAll('.test-parameter, .test-result').forEach(field => {
            field.addEventListener('input', () => {
                if (updateTimeout) clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => updatePreview(), 500);
            });
        });
        
        newRow.querySelector('.remove-test-btn').addEventListener('click', function() {
            newRow.remove();
            updatePreview();
        });
        
        newRow.querySelector('.test-parameter').focus();
    }

    function addSpecification() {
        const tbody = document.querySelector('#specificationsTable tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>
                <input type="text" class="form-control form-control-sm editable-cell spec-name border-0" 
                       placeholder="Specification name">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm editable-cell spec-value border-0" 
                       placeholder="Value">
            </td>
            <td class="table-actions">
                <button type="button" class="btn btn-outline-danger btn-sm remove-spec-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
        
        // Initialize handlers
        const specName = newRow.querySelector('.spec-name');
        const specValue = newRow.querySelector('.spec-value');
        
        specValue.addEventListener('input', function() {
            const name = specName.value.trim();
            const value = this.value;
            if (name && updateTimeout) clearTimeout(updateTimeout);
            if (name) {
                updateTimeout = setTimeout(() => updateSpecification(name, value), 500);
            }
        });
        
        newRow.querySelector('.remove-spec-btn').addEventListener('click', function() {
            newRow.remove();
            updatePreview();
        });
        
        specName.focus();
    }

    // Global functions
    window.switchPreview = switchPreview;
    window.addTestResult = addTestResult;
    window.addSpecification = addSpecification;
    
    window.approveDocuments = function() {
        const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
        modal.show();
    };
    
    window.confirmApproval = function() {
        window.location.href = `/results/${docSetId}`;
    };
});
</script>
{% endblock %}