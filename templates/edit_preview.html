{% extends "base.html" %}

{% block title %}Edit & Preview - Chemical Document Automation{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Pipeline Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="pipeline-progress">
                        <div class="progress-step completed">
                            <div class="step-icon">
                                <i class="fas fa-upload"></i>
                            </div>
                            <div class="step-label">Upload</div>
                        </div>
                        <div class="progress-step completed">
                            <div class="step-icon">
                                <i class="fas fa-magic"></i>
                            </div>
                            <div class="step-label">Extract</div>
                        </div>
                        <div class="progress-step active">
                            <div class="step-icon">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="step-label">Edit & Preview</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="step-label">Approve</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-signature"></i>
                            </div>
                            <div class="step-label">Sign</div>
                        </div>
                        <div class="progress-step">
                            <div class="step-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="step-label">Export</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Edit Fields -->
        <div class="col-md-4">
            <div class="card sticky-top">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Edit Extracted Data
                    </h5>
                </div>
                <div class="card-body edit-panel">
                    <!-- Document Type Indicator -->
                    <div class="mb-3">
                        <span class="badge bg-primary" id="currentDocumentType">COA Fields</span>
                    </div>
                    
                    <form id="editForm" onsubmit="return false;">
                        <!-- Common Fields (shown for all documents) -->
                        <div id="commonFields">
                            <h6 class="text-muted mb-3">Basic Information</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Company Product Name</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="company_product_name" 
                                       value="{{ doc_set.company_product_name }}"
                                       placeholder="Enter product name">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Supplier Name</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="supplier_name" 
                                       value="{{ doc_set.supplier_name or '' }}"
                                       placeholder="Enter supplier name">
                            </div>
                        </div>

                        <!-- COA Specific Fields -->
                        <div id="coaFields" class="document-fields">
                            <h6 class="text-muted mb-3 mt-4">Certificate of Analysis Fields</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">INCI Name</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="inci_name" 
                                       value="{{ doc_set.inci_name or '' }}"
                                       placeholder="Enter INCI name">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Batch Number</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="batch_number" 
                                       value="{{ doc_set.batch_number or '' }}"
                                       placeholder="Enter batch number">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Manufacturing Date</label>
                                <input type="date" class="form-control editable-field" 
                                       data-field="manufacturing_date" 
                                       value="{% if doc_set.manufacturing_date %}{{ doc_set.manufacturing_date.strftime('%Y-%m-%d') }}{% endif %}">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Expiry Date</label>
                                <input type="date" class="form-control editable-field" 
                                       data-field="expiry_date" 
                                       value="{% if doc_set.expiry_date %}{{ doc_set.expiry_date.strftime('%Y-%m-%d') }}{% endif %}">
                            </div>

                            <!-- Test Results Section -->
                            <h6 class="text-muted mb-3 mt-4">Test Results</h6>
                            
                            <div id="testResultsContainer">
                                {% for test in doc_set.test_results %}
                                <div class="test-result-item mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small">Test Parameter</label>
                                            <input type="text" class="form-control form-control-sm test-parameter" 
                                                   value="{{ test.parameter_name }}" 
                                                   data-test-id="{{ test.id }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Test Result</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-sm test-result" 
                                                       value="{{ test.result }}"
                                                       data-test-id="{{ test.id }}">
                                                <button type="button" class="btn btn-outline-danger btn-sm remove-test-btn"
                                                        data-test-id="{{ test.id }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm mb-4" onclick="addTestResult()">
                                <i class="fas fa-plus me-1"></i>
                                Add Test Result
                            </button>
                        </div>

                        <!-- MSDS Specific Fields -->
                        <div id="msdsFields" class="document-fields" style="display: none;">
                            <h6 class="text-muted mb-3 mt-4">Material Safety Data Sheet Fields</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">CAS Number</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="cas_number" 
                                       value="{{ doc_set.cas_number or '' }}"
                                       placeholder="Enter CAS number">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Molecular Formula</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="molecular_formula" 
                                       value="{{ doc_set.molecular_formula or '' }}"
                                       placeholder="Enter molecular formula">
                            </div>

                            <!-- Physical Properties -->
                            <h6 class="text-muted mb-3 mt-4">Physical Properties</h6>
                            
                            {% set physical_props = extracted_data.get('physical_properties', {}) %}
                            <div class="mb-3">
                                <label class="form-label">Appearance</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="physical_properties.appearance" 
                                       value="{{ physical_props.get('appearance', '') }}"
                                       placeholder="Enter appearance">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Solubility</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="physical_properties.solubility" 
                                       value="{{ physical_props.get('solubility', '') }}"
                                       placeholder="Enter solubility">
                            </div>

                            <!-- Safety Data -->
                            <h6 class="text-muted mb-3 mt-4">Safety Information</h6>
                            
                            {% set safety_data = extracted_data.get('safety_data', {}) %}
                            <div class="mb-3">
                                <label class="form-label">pH Value</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="safety_data.ph" 
                                       value="{{ safety_data.get('ph', '') }}"
                                       placeholder="Enter pH value">
                            </div>
                        </div>

                        <!-- TDS Specific Fields -->
                        <div id="tdsFields" class="document-fields" style="display: none;">
                            <h6 class="text-muted mb-3 mt-4">Technical Data Sheet Fields</h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Recommended Use Level</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="recommended_use_level" 
                                       value="{{ extracted_data.get('recommended_use_level', '') }}"
                                       placeholder="Enter recommended use level">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Use Method</label>
                                <textarea class="form-control editable-field" 
                                          data-field="use_method" 
                                          rows="2"
                                          placeholder="Enter use method">{{ extracted_data.get('use_method', '') }}</textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Storage Conditions</label>
                                <textarea class="form-control editable-field" 
                                          data-field="storage_conditions" 
                                          rows="2"
                                          placeholder="Enter storage conditions">{{ extracted_data.get('storage_conditions', '') }}</textarea>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Shelf Life</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="shelf_life" 
                                       value="{{ extracted_data.get('shelf_life', '') }}"
                                       placeholder="Enter shelf life">
                            </div>

                            <!-- Specifications -->
                            <h6 class="text-muted mb-3 mt-4">Technical Specifications</h6>
                            
                            <div id="specificationsContainer">
                                {% set specs = extracted_data.get('specifications', {}) %}
                                {% for spec_name, spec_value in specs.items() %}
                                <div class="specification-item mb-3 p-3 border rounded">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small">Specification Name</label>
                                            <input type="text" class="form-control form-control-sm spec-name" 
                                                   value="{{ spec_name }}" 
                                                   data-original-name="{{ spec_name }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Specification Value</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-sm spec-value" 
                                                       value="{{ spec_value }}"
                                                       data-spec-name="{{ spec_name }}">
                                                <button type="button" class="btn btn-outline-danger btn-sm remove-spec-btn">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm mb-4" onclick="addSpecification()">
                                <i class="fas fa-plus me-1"></i>
                                Add Specification
                            </button>
                        </div>



                    </form>

                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-success" onclick="approveDocuments()">
                            <i class="fas fa-check me-2"></i>
                            Approve Documents
                        </button>
                        <a href="{{ url_for('upload') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Upload
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Preview -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Live Preview
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm active" 
                                    onclick="switchPreview('coa')" id="previewBtnCoa">
                                COA
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="switchPreview('msds')" id="previewBtnMsds">
                                MSDS
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="switchPreview('tds')" id="previewBtnTds">
                                TDS
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="preview-container">
                        <div id="previewLoading" class="d-none">
                            <div class="text-center p-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Updating preview...</p>
                            </div>
                        </div>
                        <iframe id="previewFrame" 
                                src="{{ url_for('preview_document', doc_set_id=doc_set.id, doc_type='coa') }}" 
                                style="width: 100%; height: 800px; border: none;">
                        </iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div class="modal fade" id="approvalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approve Documents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to approve these documents? This will move you to the signing phase.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    You can still make changes after approval but before signing.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('approve_documents', doc_set_id=doc_set.id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-2"></i>
                        Approve & Continue
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const docSetId = {{ doc_set.id }};
    let currentPreview = 'coa';
    let updateTimeout = null;

    // Initialize edit handlers
    document.querySelectorAll('.editable-field').forEach(field => {
        field.addEventListener('input', function() {
            const fieldName = this.dataset.field;
            const fieldValue = this.value;
            
            // Clear existing timeout
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // Set new timeout for 500ms after user stops typing
            updateTimeout = setTimeout(() => {
                updateField(fieldName, fieldValue);
            }, 500);
        });
    });

    // Initialize specification handlers
    initializeSpecificationHandlers();
    
    // Initialize document field switching - show COA fields by default
    switchPreview('coa');

    function initializeSpecificationHandlers() {
        // Handle specification value changes
        document.querySelectorAll('.spec-value').forEach(field => {
            field.addEventListener('input', function() {
                const specName = this.dataset.specName;
                const specValue = this.value;
                
                // Clear existing timeout
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }
                
                // Set new timeout for 500ms after user stops typing
                updateTimeout = setTimeout(() => {
                    updateSpecification(specName, specValue);
                }, 500);
            });
        });

        // Handle specification name changes
        document.querySelectorAll('.spec-name').forEach(field => {
            field.addEventListener('blur', function() {
                const originalName = this.dataset.originalName;
                const newName = this.value.trim();
                
                if (originalName !== newName && newName) {
                    renameSpecification(originalName, newName);
                }
            });
        });

        // Handle remove specification buttons
        document.querySelectorAll('.remove-spec-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const specItem = this.closest('.specification-item');
                const specName = specItem.querySelector('.spec-name').value;
                removeSpecification(specName, specItem);
            });
        });
    }

    async function updateField(fieldName, fieldValue) {
        try {
            const response = await fetch(`/api/update-field/${docSetId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    field_name: fieldName,
                    field_value: fieldValue
                })
            });
            
            if (response.ok) {
                // Update preview after successful field update
                updatePreview();
            } else {
                console.error('Failed to update field');
            }
        } catch (error) {
            console.error('Error updating field:', error);
        }
    }

    async function updatePreview() {
        const previewFrame = document.getElementById('previewFrame');
        const loadingDiv = document.getElementById('previewLoading');
        
        // Show loading state
        loadingDiv.classList.remove('d-none');
        previewFrame.style.opacity = '0.3';
        
        // Add timestamp to force refresh
        const timestamp = new Date().getTime();
        const newSrc = `/api/preview/${docSetId}/${currentPreview}?t=${timestamp}`;
        
        previewFrame.onload = function() {
            loadingDiv.classList.add('d-none');
            previewFrame.style.opacity = '1';
        };
        
        previewFrame.src = newSrc;
    }

    function switchPreview(docType) {
        currentPreview = docType;
        
        // Update button states
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`previewBtn${docType.charAt(0).toUpperCase() + docType.slice(1)}`).classList.add('active');
        
        // Update document type indicator
        const indicator = document.getElementById('currentDocumentType');
        const documentNames = {
            'coa': 'COA Fields',
            'msds': 'MSDS Fields', 
            'tds': 'TDS Fields'
        };
        indicator.textContent = documentNames[docType] || 'Document Fields';
        
        // Show/hide appropriate field sections
        document.querySelectorAll('.document-fields').forEach(section => {
            section.style.display = 'none';
        });
        
        const targetSection = document.getElementById(`${docType}Fields`);
        if (targetSection) {
            targetSection.style.display = 'block';
        }
        
        // Update preview
        updatePreview();
    }

    async function updateSpecification(specName, specValue) {
        try {
            const response = await fetch(`/api/update-specification/${docSetId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    spec_name: specName,
                    spec_value: specValue
                })
            });
            
            if (response.ok) {
                updatePreview();
            } else {
                console.error('Failed to update specification');
            }
        } catch (error) {
            console.error('Error updating specification:', error);
        }
    }

    async function renameSpecification(oldName, newName) {
        try {
            const response = await fetch(`/api/rename-specification/${docSetId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    old_name: oldName,
                    new_name: newName
                })
            });
            
            if (response.ok) {
                // Update the data attributes
                const specItem = document.querySelector(`[data-original-name="${oldName}"]`).closest('.specification-item');
                specItem.querySelector('.spec-name').dataset.originalName = newName;
                specItem.querySelector('.spec-value').dataset.specName = newName;
                updatePreview();
            } else {
                console.error('Failed to rename specification');
            }
        } catch (error) {
            console.error('Error renaming specification:', error);
        }
    }

    async function removeSpecification(specName, specElement) {
        try {
            const response = await fetch(`/api/remove-specification/${docSetId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    spec_name: specName
                })
            });
            
            if (response.ok) {
                specElement.remove();
                updatePreview();
            } else {
                console.error('Failed to remove specification');
            }
        } catch (error) {
            console.error('Error removing specification:', error);
        }
    }

    function addSpecification() {
        const container = document.getElementById('specificationsContainer');
        const newSpecItem = document.createElement('div');
        newSpecItem.className = 'specification-item mb-3 p-3 border rounded';
        newSpecItem.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label small">Specification Name</label>
                    <input type="text" class="form-control form-control-sm spec-name" 
                           value="" 
                           data-original-name=""
                           placeholder="Enter specification name">
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Specification Value</label>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm spec-value" 
                               value=""
                               data-spec-name=""
                               placeholder="Enter specification value">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-spec-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(newSpecItem);
        
        // Initialize handlers for new specification
        const specName = newSpecItem.querySelector('.spec-name');
        const specValue = newSpecItem.querySelector('.spec-value');
        const removeBtn = newSpecItem.querySelector('.remove-spec-btn');
        
        // Handle specification name changes
        specName.addEventListener('blur', function() {
            const name = this.value.trim();
            if (name) {
                this.dataset.originalName = name;
                specValue.dataset.specName = name;
                updateSpecification(name, specValue.value);
            }
        });
        
        // Handle specification value changes
        specValue.addEventListener('input', function() {
            const specName = this.dataset.specName;
            const specValue = this.value;
            
            if (specName) {
                // Clear existing timeout
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }
                
                // Set new timeout for 500ms after user stops typing
                updateTimeout = setTimeout(() => {
                    updateSpecification(specName, specValue);
                }, 500);
            }
        });
        
        // Handle remove button
        removeBtn.addEventListener('click', function() {
            const nameValue = specName.value.trim();
            if (nameValue) {
                removeSpecification(nameValue, newSpecItem);
            } else {
                newSpecItem.remove();
            }
        });
        
        // Focus on the name input
        specName.focus();
    }

    function addTestResult() {
        const container = document.getElementById('testResultsContainer');
        const newTestItem = document.createElement('div');
        newTestItem.className = 'test-result-item mb-3 p-3 border rounded';
        newTestItem.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label small">Test Parameter</label>
                    <input type="text" class="form-control form-control-sm test-parameter" 
                           value="" 
                           placeholder="Enter test parameter">
                </div>
                <div class="col-md-6">
                    <label class="form-label small">Test Result</label>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm test-result" 
                               value=""
                               placeholder="Enter test result">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-test-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(newTestItem);
        
        // Initialize handlers for new test result
        const testParameter = newTestItem.querySelector('.test-parameter');
        const testResult = newTestItem.querySelector('.test-result');
        const removeBtn = newTestItem.querySelector('.remove-test-btn');
        
        // Handle remove button
        removeBtn.addEventListener('click', function() {
            newTestItem.remove();
            updatePreview();
        });
        
        // Handle field changes
        [testParameter, testResult].forEach(field => {
            field.addEventListener('input', function() {
                // Clear existing timeout
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }
                
                // Set new timeout for 500ms after user stops typing
                updateTimeout = setTimeout(() => {
                    updatePreview();
                }, 500);
            });
        });
        
        // Focus on the parameter input
        testParameter.focus();
    }

    function approveDocuments() {
        const approvalModal = new bootstrap.Modal(document.getElementById('approvalModal'));
        approvalModal.show();
    }
</script>
{% endblock %}