{% extends "base.html" %}

{% block title %}Document Processing Pipeline{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Document Processing Pipeline
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Pipeline Progress -->
                    <div class="mb-4">
                        <div id="pipeline-progress" class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progress-bar">
                            </div>
                        </div>
                        <div id="progress-text" class="text-center text-muted">
                            Initializing pipeline...
                        </div>
                    </div>

                    <!-- Pipeline Steps -->
                    <div class="row">
                        <div class="col-12">
                            <div id="pipeline-steps">
                                <!-- Step 1: File Upload -->
                                <div class="pipeline-step mb-3" id="step-upload">
                                    <div class="card bg-secondary border-light">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="step-icon me-3">
                                                    <i class="fas fa-upload text-muted" id="icon-upload"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">File Upload & Validation</h6>
                                                    <small class="text-muted" id="status-upload">Waiting for files...</small>
                                                </div>
                                                <div class="spinner-border spinner-border-sm text-primary d-none" id="spinner-upload"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2: Document Processing -->
                                <div class="pipeline-step mb-3" id="step-processing">
                                    <div class="card bg-secondary border-light">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="step-icon me-3">
                                                    <i class="fas fa-file-pdf text-muted" id="icon-processing"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">Document Processing</h6>
                                                    <small class="text-muted" id="status-processing">Extracting text from PDFs...</small>
                                                </div>
                                                <div class="spinner-border spinner-border-sm text-primary d-none" id="spinner-processing"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 3: Mistral OCR -->
                                <div class="pipeline-step mb-3" id="step-mistral-ocr">
                                    <div class="card bg-secondary border-light">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="step-icon me-3">
                                                    <i class="fas fa-eye text-muted" id="icon-mistral-ocr"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">Mistral OCR Enhancement</h6>
                                                    <small class="text-muted" id="status-mistral-ocr">Enhancing text extraction with AI...</small>
                                                </div>
                                                <div class="spinner-border spinner-border-sm text-primary d-none" id="spinner-mistral-ocr"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 4: Field Validation -->
                                <div class="pipeline-step mb-3" id="step-validation">
                                    <div class="card bg-secondary border-light">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="step-icon me-3">
                                                    <i class="fas fa-check-circle text-muted" id="icon-validation"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">Mistral Field Validation</h6>
                                                    <small class="text-muted" id="status-validation">Validating and correcting extracted data...</small>
                                                </div>
                                                <div class="spinner-border spinner-border-sm text-primary d-none" id="spinner-validation"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 5: Document Generation -->
                                <div class="pipeline-step mb-3" id="step-generation">
                                    <div class="card bg-secondary border-light">
                                        <div class="card-body py-2">
                                            <div class="d-flex align-items-center">
                                                <div class="step-icon me-3">
                                                    <i class="fas fa-file-alt text-muted" id="icon-generation"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-0">Document Generation</h6>
                                                    <small class="text-muted" id="status-generation">Creating branded documents...</small>
                                                </div>
                                                <div class="spinner-border spinner-border-sm text-primary d-none" id="spinner-generation"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Form -->
                    <div class="mt-4" id="upload-form-container">
                        <form id="upload-form" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="coa-file" class="form-label">
                                            <i class="fas fa-certificate text-primary me-2"></i>
                                            Certificate of Analysis (COA)
                                        </label>
                                        <input type="file" class="form-control bg-dark border-secondary text-light" 
                                               id="coa-file" name="coa" accept=".pdf" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="msds-file" class="form-label">
                                            <i class="fas fa-shield-alt text-warning me-2"></i>
                                            Material Safety Data Sheet (MSDS)
                                        </label>
                                        <input type="file" class="form-control bg-dark border-secondary text-light" 
                                               id="msds-file" name="msds" accept=".pdf" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="tds-file" class="form-label">
                                            <i class="fas fa-clipboard-list text-info me-2"></i>
                                            Technical Data Sheet (TDS)
                                        </label>
                                        <input type="file" class="form-control bg-dark border-secondary text-light" 
                                               id="tds-file" name="tds" accept=".pdf" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg" id="start-processing">
                                    <i class="fas fa-play me-2"></i>
                                    Start Processing
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Results -->
                    <div class="mt-4 d-none" id="results-container">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>Processing Complete!</h5>
                            <p class="mb-0">Your documents have been processed successfully.</p>
                        </div>
                        <div class="text-center">
                            <a href="#" class="btn btn-success" id="view-results">
                                <i class="fas fa-eye me-2"></i>
                                View Results
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('upload-form');
    const startBtn = document.getElementById('start-processing');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const resultsContainer = document.getElementById('results-container');
    
    let currentStep = 0;
    const steps = ['upload', 'processing', 'mistral-ocr', 'validation', 'generation'];
    
    function updateStep(stepName, status, message) {
        const icon = document.getElementById(`icon-${stepName}`);
        const statusText = document.getElementById(`status-${stepName}`);
        const spinner = document.getElementById(`spinner-${stepName}`);
        
        if (status === 'active') {
            icon.className = 'fas fa-clock text-warning';
            spinner.classList.remove('d-none');
            statusText.textContent = message || 'In progress...';
            statusText.className = 'text-warning';
        } else if (status === 'complete') {
            icon.className = 'fas fa-check-circle text-success';
            spinner.classList.add('d-none');
            statusText.textContent = message || 'Complete';
            statusText.className = 'text-success';
        } else if (status === 'error') {
            icon.className = 'fas fa-exclamation-circle text-danger';
            spinner.classList.add('d-none');
            statusText.textContent = message || 'Error';
            statusText.className = 'text-danger';
        }
    }
    
    function updateProgress(percentage, text) {
        progressBar.style.width = percentage + '%';
        progressText.textContent = text;
    }
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        startBtn.disabled = true;
        
        try {
            updateStep('upload', 'active', 'Uploading files...');
            updateProgress(10, 'Uploading files...');
            
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                updateStep('upload', 'complete', 'Files uploaded successfully');
                updateStep('processing', 'active', 'Processing documents...');
                updateProgress(30, 'Processing documents...');
                
                // Simulate processing steps
                setTimeout(() => {
                    updateStep('processing', 'complete', 'Text extraction complete');
                    updateStep('mistral-ocr', 'active', 'Enhancing with Mistral AI...');
                    updateProgress(50, 'Enhancing text with AI...');
                }, 1000);
                
                setTimeout(() => {
                    updateStep('mistral-ocr', 'complete', 'OCR enhancement complete');
                    updateStep('validation', 'active', 'Validating fields...');
                    updateProgress(70, 'Validating extracted data...');
                }, 2000);
                
                setTimeout(() => {
                    updateStep('validation', 'complete', 'Field validation complete');
                    updateStep('generation', 'active', 'Generating documents...');
                    updateProgress(90, 'Creating branded documents...');
                }, 3000);
                
                setTimeout(() => {
                    updateStep('generation', 'complete', 'Documents generated successfully');
                    updateProgress(100, 'Processing complete!');
                    resultsContainer.classList.remove('d-none');
                    
                    // Get the redirect URL from response
                    const result = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(result, 'text/html');
                    const metaRedirect = doc.querySelector('meta[http-equiv="refresh"]');
                    
                    if (metaRedirect) {
                        const content = metaRedirect.getAttribute('content');
                        const url = content.split('url=')[1];
                        document.getElementById('view-results').href = url;
                    }
                }, 4000);
                
            } else {
                updateStep('upload', 'error', 'Upload failed');
                updateProgress(0, 'Upload failed');
                alert('Upload failed. Please try again.');
                startBtn.disabled = false;
            }
            
        } catch (error) {
            updateStep('upload', 'error', 'Connection error');
            updateProgress(0, 'Connection error');
            alert('Network error. Please try again.');
            startBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}